<html>
<head>
  <meta charset="utf-8" />
  <title>Carburants</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/5.10.3/math.min.js"></script>

  <link rel="stylesheet" href="./dist/MarkerCluster.css" />
  <link rel="stylesheet" href="./dist/MarkerCluster.Default.css" />
  <script src="./dist/leaflet.markercluster-src.js"></script>

  <script src="./json/address_points.js"></script>

  <meta charset=utf-8>

  <style>
    #map{ width: 100%; height: 100%; }
  </style>
</head>

<body>

  <a href="https://github.com/Hatrix42/opencarbumap"><img style="position: absolute; top: 0; right: 0; border: 0; z-index:1000;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
  <div id="map"></div>

  <script type="text/javascript">

   var dynamic = false;
   var tiles = L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png',
        {
          type: 'map',
          maxZoom: 19,
          minZoom: 2,
        }), latlng = L.latLng(46, 5.2);

    var fuel_list = ['E10', 'E85', 'GPLc', 'Gazole', 'SP95', 'SP98'];
    var iconColors = ['blue', 'green', 'yellow', 'orange', 'red', 'black'];
    var icons = {};
    for (var i = 0; i < iconColors.length; i++) {
        icons[i] = L.icon({
            iconUrl: './images/marker-icon-'+iconColors[i]+'.png',
            shadowUrl: './images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    // Initialize Layers for each fuel
    var overlayMaps = {};
    for (var i = 0; i < fuel_list.length; i++) {
      var markers = L.markerClusterGroup({
        removeOutsideVisibleBounds: true,
        disableClusteringAtZoom: 11,
        maxClusterRadius: 60
      });
      overlayMaps[fuel_list[i]] = markers;
    }

    for (var i = 0; i < addressPoints.length; i++) {
      var a = addressPoints[i];
      var city = a[2];
      var prices = a[3];
      var title = city;

      for (var j in a[3]) {
        title = title + '<br>' + j + ": " + a[3][j].toFixed(3) + " â‚¬/Litre";
      }

      for (var fuel_name in a[3]) {
        var price = a[3][fuel_name];

        var marker = L.marker(new L.LatLng(a[0], a[1]), { title: city, icon: icons[0]});
        marker.bindPopup(title);
        overlayMaps[fuel_name].addLayer(marker);
        marker.prices = prices;
      }

    }

    var map = L.map('map', {
        center: latlng, 
        zoom: 6, 
        layers: [tiles, overlayMaps["Gazole"]]
    });

    map.on('moveend overlayadd', function(e) {
        var overlay_name = "";
        for (var name in overlayMaps) {
            if (map.hasLayer(overlayMaps[name])) {
                overlay_name = name;
                break;
            }
        }

        var visibleMarkers = [];
        var bounds = map.getBounds()
        overlayMaps[overlay_name].eachLayer(function(marker) {
            if (!dynamic || bounds.contains(marker.getLatLng())) {
                visibleMarkers.push(marker);
            }
        });
        
        var prices = [];
        for (var marker of visibleMarkers) {
            prices.push(marker.prices[overlay_name]);
        }

        var quantiles = math.quantileSeq(prices, [...[...Array(5).keys()].map(x => (x+1) / 6)])

        for (var marker of visibleMarkers) {
            var price = marker.prices[overlay_name];
            var setted = false;
            for (var quantile in quantiles) {
                if (price <= quantiles[quantile]) {
                   marker.setIcon(icons[quantile]);
                   setted = true;
                   break;
                }
            }
            if (!setted) marker.setIcon(icons[5]);
        }
    });

    L.Control.DynamicCheckBox = L.Control.extend({
        input: undefined,
        onAdd: function(map) {
            input = L.DomUtil.create('input');
            input.type = "checkbox";
            input.name = "DynamicRange";
            L.DomEvent.on(input, 'click', function() {dynamic = input.checked});
            return input;
        },
    
        onRemove: function(map) {
            L.DomEvent.off(input);
        }
    });
    
    L.control.dynamicCheckBox = function(opts) {
        return new L.Control.DynamicCheckBox(opts);
    }

    L.control.layers(overlayMaps, null, {position: 'topleft'}).addTo(map);
    L.control.scale().addTo(map);
    L.control.dynamicCheckBox({ position: 'topleft' }).addTo(map);


  </script>


</body>
</html>
